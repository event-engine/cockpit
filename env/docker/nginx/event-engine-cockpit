FROM nginx:1.19-alpine

RUN rm /etc/nginx/conf.d/default.conf

RUN apk update \
    && apk add git pcre pcre-dev openssl wget g++ zlib-dev make

RUN cd ~/ \
    && wget https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz \
    && tar zxvf nginx-${NGINX_VERSION}.tar.gz

RUN cd ~/ \
    && git clone https://github.com/google/ngx_brotli.git \
    && cd ~/ngx_brotli \
    && git submodule update --init

RUN cd ~/nginx-${NGINX_VERSION} \
    && ./configure --with-compat --add-dynamic-module=../ngx_brotli \
    && make modules \
    && cp objs/*.so /etc/nginx/modules

RUN rm -rf ~/nginx-${NGINX_VERSION} ~/nginx-${NGINX_VERSION}.tar.gz ~/nginx_brotli

RUN echo 'load_module modules/ngx_http_brotli_filter_module.so;load_module modules/ngx_http_brotli_static_module.so;' | cat - /etc/nginx/nginx.conf > temp && mv temp /etc/nginx/nginx.conf

COPY ./env/docker/nginx/conf/* /etc/nginx/conf.d

COPY ./env/docker/nginx/dev_certificates/* /etc/certificates/event-engine-cockpit/

COPY ./build /var/www

WORKDIR /var/www
